package com.peachspot.legendkofarm.ui.screens

import android.annotation.SuppressLint
import android.app.Activity
import android.content.Intent
import android.net.Uri
import android.util.Log
import android.webkit.*
import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.stringResource
import androidx.navigation.NavController
import com.peachspot.legendkofarm.R
import com.peachspot.legendkofarm.ui.components.MyAppTopBar
import com.peachspot.legendkofarm.viewmodel.HomeViewModel
import androidx.compose.ui.unit.dp
import androidx.core.app.ActivityCompat.startActivityForResult
import com.google.accompanist.permissions.PermissionState
import com.google.accompanist.permissions.rememberPermissionState
import com.google.accompanist.permissions.ExperimentalPermissionsApi
import com.google.accompanist.permissions.isGranted

import com.peachspot.legendkofarm.MainActivity
import com.peachspot.legendkofarm.ui.components.CommonWebView

import com.peachspot.legendkofarm.ui.navigation.AppScreenRoutes
import com.peachspot.legendkofarm.util.Logger
import com.peachspot.legendkofarm.viewmodel.HomeUiState





@OptIn(ExperimentalPermissionsApi::class,ExperimentalMaterial3Api::class)
@SuppressLint("SetJavaScriptEnabled")
@Composable
fun DiaryScreen(
    viewModel: HomeViewModel,
    navController: NavController,
    modifier: Modifier = Modifier,
    onFileChooserRequest: (ValueCallback<Array<Uri>>, Intent) -> Unit
) {
    val uiState by viewModel.uiState.collectAsState()
    val snackbarHostState = remember { SnackbarHostState() }
    val context = LocalContext.current
    val activity = context as? Activity

    var showUrlPopup by remember { mutableStateOf(false) }
    var popupUrl by remember { mutableStateOf<String?>(null) }
    var webViewForPopup by remember { mutableStateOf<WebView?>(null) }

    var showAlert by remember { mutableStateOf(false) }
    var alertMessage by remember { mutableStateOf<String?>(null) }
    var jsAlertResult by remember { mutableStateOf<JsResult?>(null) }


    val cameraPermissionState = rememberPermissionState(android.Manifest.permission.CAMERA)

    LaunchedEffect(cameraPermissionState.status) {
        if (!cameraPermissionState.status.isGranted) {
            Log.d("DiaryScreen", "Requesting camera permission")
            cameraPermissionState.launchPermissionRequest()
        }
    }

    if (cameraPermissionState.status.isGranted) {
        Text("Ïπ¥Î©îÎùº Í∂åÌïú ÌóàÏö©Îê®")
    } else {
        Text("Ïπ¥Î©îÎùº Í∂åÌïú ÌïÑÏöî")
        Button(onClick = { cameraPermissionState.launchPermissionRequest() }) {
            Text("Í∂åÌïú ÏöîÏ≤≠")
        }
    }


//
//    val coroutineScope = rememberCoroutineScope()
//    var isRefreshing by remember { mutableStateOf(false) }
//
//    val webView = remember {
//        WebView(context).apply {
//            settings.javaScriptEnabled = true
//            settings.domStorageEnabled = true
//            settings.javaScriptCanOpenWindowsAutomatically = true
//            settings.setSupportMultipleWindows(true)
//            settings.loadWithOverviewMode = true
//            settings.useWideViewPort = true
//            loadUrl("https://urdesk.co.kr/legendkofarm/diary")
//        }
//    }

    LaunchedEffect(uiState.userMessage) {
        uiState.userMessage?.let { message ->
            snackbarHostState.showSnackbar(
                message = message,
                duration = SnackbarDuration.Short
            )
            viewModel.clearUserMessage()
        }
    }

//
//
//    if (showAlert) {
//        AlertDialog(
//            onDismissRequest = {
//                jsAlertResult?.cancel()
//                showAlert = false
//            },
//            title = { Text("ÏïåÎ¶º") },
//            text = { Text(alertMessage ?: "") },
//            confirmButton = {
//                TextButton(onClick = {
//                    jsAlertResult?.confirm()
//                    showAlert = false
//                }) {
//                    Text("ÌôïÏù∏")
//                }
//            }
//        )
//    }

    Scaffold(
        snackbarHost = {
            SnackbarHost(hostState = snackbarHostState) { snackbarData ->
                val containerColor = when (uiState.userMessageType) {
                    HomeScreenContentTypes.INFO, HomeScreenContentTypes.SUCCESS -> Color(0xFF4CAF50)
                    HomeScreenContentTypes.ERROR -> Color(0xFFFF0000)
                    else -> MaterialTheme.colorScheme.surfaceVariant
                }
                val contentColor = when (uiState.userMessageType) {
                    HomeScreenContentTypes.ERROR -> MaterialTheme.colorScheme.onError
                    else -> MaterialTheme.colorScheme.onSurfaceVariant
                }
                Snackbar(
                    snackbarData = snackbarData,
                    containerColor = containerColor,
                    contentColor = contentColor
                )
            }
        },
        topBar = {
            MyAppTopBar(
                title = stringResource(R.string.screen_title_building),
                onNotificationClick = {
                    navController.navigate(AppScreenRoutes.NOTIFICATION_SCREEN)
                },
                onTitleClick = {
                    // üëâ Ìôà ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
                    navController.navigate("home_tab_host") {
                        //popUpTo("home") { inclusive = true }
                    }
                }
            )
        }

    ) { innerPadding ->
        Box(
            modifier = modifier
                //.padding(innerPadding)
                .fillMaxSize()
        ) {


            if (!uiState.isUserLoggedIn) {
                // Î°úÍ∑∏Ïù∏ ÌôîÎ©¥
                Column(
                    modifier = Modifier.fillMaxSize(),
                    verticalArrangement = Arrangement.Center,
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {


                    Spacer(Modifier.height(24.dp)) // ÏÉÅÎã® Ïó¨Î∞±

                    Text(text = "ÌîÑÎ°úÌïÑÏóêÏÑú Íµ¨Í∏Ä Ïó∞Îèô Ïù¥ÌõÑ ÏÇ¨Ïö©Í∞ÄÎä• Ìï©ÎãàÎã§.")

                    Button(
                        onClick = {
                            navController.navigate(AppScreenRoutes.PROFILE_SCREEN)
                        }

                    ) {
                        Text("Ïù¥Îèô")
                    }


                }
            } else {


                CommonWebView(
                    url = "https://urdesk.co.kr/smartkofarmDiary",
                    modifier = modifier
                        .padding(innerPadding)
                        .fillMaxSize(),
                    onShowPopup = { url, webView ->
                        popupUrl = url
                        webViewForPopup = webView
                        showUrlPopup = true
                    },
                    onJsAlert = { message, result ->
                        alertMessage = message
                        jsAlertResult = result
                        showAlert = true
                    },
                    onFileChooserRequest = onFileChooserRequest
                )
            }


        }
    }
}


@Composable
fun LoggedInUserProfile(uiState: HomeUiState, onSignOutClicked: () -> Unit) {
    Column(horizontalAlignment = Alignment.CenterHorizontally) {
        Logger.d("NICAP", uiState.toString());
        /*uiState.userPhotoUrl?.let {
            AsyncImage(
                model = it,
                contentDescription = "User Profile Photo",
                modifier = Modifier.size(100.dp)
            )
            Spacer(Modifier.height(16.dp))
        }
        uiState.userName?.let { Text("Ïù¥Î¶Ñ: $it", style = MaterialTheme.typography.headlineSmall) }
        uiState.userEmail?.let { Text("Ïù¥Î©îÏùº: $it", style = MaterialTheme.typography.bodyLarge) }
        Spacer(Modifier.height(24.dp))*/

        Button(onClick = onSignOutClicked) { Text("Google Î°úÍ∑∏ÏïÑÏõÉ") }
    }
}


@Composable
fun LoginPrompt(onSignInClicked: () -> Unit, enabled: Boolean = true) { // enabled ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä Î∞è Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
    Column(horizontalAlignment = Alignment.CenterHorizontally) {
        Spacer(Modifier.height(16.dp))
        Button(
            onClick = onSignInClicked,
            enabled = enabled // Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉúÎ•º ÌååÎùºÎØ∏ÌÑ∞Î°ú Ï†úÏñ¥
        ) {
            Text("Google Ïó∞Îèô")
        }
    }
}
